# 서버 설정 최적화
> mySQL 서버에 적합한 설정 파일을 만드는 법
- 단순하게 사양만 보고 적합한 값을 고를 순 없다.
- 기본값이 정해진 데에는 이유가 있어서, 잘 모르고 변경시 심각한 사이드 이펙트가 있을 수 있다.


## 설정 동작 방식
- 영구적으로 사용하려는 설정은 명령줄 지정보다 전역 설정 파일에 추가할 것
- 설정은 서버전체/각 연결/객체별로 주는 등 범위를 다르게 할 수 있음
- 전역 변수도 서버를 재시작하면 대부분 리셋됨 (런타임 설정과 설정 파일을 관리하고, 동기화해야)
- 변경에 대한 확신 없이 전역 설정으로 만들지 말 것. 일부 버퍼는 필요하지 않아도 한번에 전체를 할당함.
- 변수 설정시 메모리 부족/서버의 스왑 등에 유의해야 함 + 변경 전에 인덱스 추가 등 가능한 대책 동원
- 하지 말아야 하는 것들
    * 설정을 바꿔가며 여러번 튜닝하는 것은 대부분 권장되지 않음. 이는 서버 내부를 연구하는 사람들에게 적합함. 다른 방법을 찾아보는 것이 효율적. (최적화 > 설정)
    * 비율로 튜닝하지 말 것. ex. `hit ratio가 낮으면 캐시 사이즈를 업데이트`
    * 인터넷의 유명한 권고들이 항상 적합하지 않을 수 있음
- 최소한의 설정은 사람들이 예상하는 것보다 훨씬 적다.
- 서버 상태 변수의 변경 사항을 확인 ($`mysqladmin extended-status -ri60`)


## 메모리 사용량 설정
- innodb_dedicated_server를 사용하면 일반적으로 RAM의 50~70%를 사용함
- 필요한 메모리들?
    * 연결: 연결을 열린 상태로 유지하기 위해 소량의 메모리 필요 + (최대 로드 시간에도)쿼리 실행을 할 수 있는 메모리 필요
    * 운영체제: 작업 수행을 위한 메모리 필요 (지표: 적은 스와핑)
    * 이노디비 버퍼 풀: 데이터가 많고 빠르게 증가할 경우 크게 설정 필요
    * 스레드 캐시: 연결을 위한 스레드를 모아두는 곳 (적게 둔다고 큰 메모리 이득은 없음)
- 예기치 않게 많은 메모리를 사용할 수 있다
    * 프리페어드 스테이트먼트는 한 번에 많은 쿼리를 연다
    * 이노디비 데이터 딕셔너리


## MySQL의 I/O 동작 설정
- 디스크 동기화 및 복구 수행에 영향을 줌
- 이노디비 트랜잭션 로그 파일 크기: `innodb_log_file_size`, `innodb_log_files_in_group`
- 로그 버퍼 크기: `innodb_log_buffer_size` (권장 범위 1-8MB)
- 로그 버퍼를 플러시하는 방법: `innodb_flush_log_at_trx_commit` (성능/손실)
- 이노디비가 로그파일과 데이터파일을 열고 플러시하는 방법: `innodb_flush_method`
- 이노디비 테이블스페이스 (디스크의 하나 이상의 파일을 포괄하는 가상 시스템. 이노디비가 데이터를 보관하는 곳.)
    * 테이블, 인덱스, 언두 로그, 변경 버퍼 등 내부 구조 데이터를 테이블스페이스에 유지
    * 테이블스페이스 파일 지정 `innodb_data_home_dir`


## 동시성 설정
- 5.7 이전의 버전을 사용한다면 서버를 업그레이드하는 것이 일반적인 해결책
- 또는 데이터를 샤딩하는 것이 좋은 해결책
- 불가능할 경우 동시성을 제한
    * 한번에 커널에 있을 수 있는 스레드 수 제한 `innodb_thread_concurrency`
    * 위 값은 사용가능한 CPU 코어 수와 동일하게 설정하고 필요에 따라 튜닝/낮추는 것이 좋음


## 안전 설정
- 성능에 영향을 미칠 수도 있으나, 일부는 합리적 트레이드오프
- 유용한 옵션
    * `max_connect_errors`
    * `max_connections`
    * `skip_name_resolve`
    * `sql_mode`
    * `sysdate_is_now`
    * `read_only`, `super_read_only`


## 고급 InnoDB 설정
- 서버 성능에 중요한 옵션 및 안전 옵션
    * `innodb_autoinc_lock_mode`
    * `innodb_buffer_pool_instancess`
    * `innodb_io_capacity`
    * `innodb_read_io_threads`, `innodb_write_io_threads`
    * `innodb_strict_mode`
    * `innodb_old_blocks_time`