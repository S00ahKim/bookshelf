# 스키마 설계와 관리
- 트레이드 오프 필요
- 스키마는 변경되기 마련
- 다른 RDBMS가 아니라 mySQL을 사용할 때의 특징


## 최적의 데이터 유형 선택
- 일반적인 지침
    * 작을수록 좋지만 잦은 변경은 지양
    * 단순한 유형이 좋음
    * 가급적 null을 피하는 게 좋음 (인덱싱과 통계값 비교가 복잡해짐 & 더 공간을 차지함)
- mySQL은 호환을 위해 `INT`에 매핑되는 `INTEGER` 등 다양한 별칭 제공 / 성능에 영향 없음
- 정수
    * 저장 공간의 크기에 따라 다양한 타입 지원 (일반적으로 `BIGINT`)
    * 음수 값을 허용하지 않는 대신 저장 가능한 양수 값을 두 배로 만들어주는 옵션도 있음 / 성능에 영향 없음
    * INT(11)과 같이 너비를 지정하는 것은 단순히 대화형 도구에서의 표기를 위함
- 실수
    * 소수 + `BIGINT`보다 더 큰 수(`DECIMAL`)
    * 부동소수점 유형이 `DECIMAL`보다 공간을 적게 차지함 / 정말 정확한 데이터가 필요한 경우에만 `DECIMAL` 권장
- 문자열
    * 가변 길이 문자열을 위한 `VARCHAR`
        + 최대값이 평균보다 훨씬 김
        + 필드의 업데이트가 드묾 (조각화가 문제되지 않음)
        + UTF-8 같은 복잡한 문자셋을 사용할 때
    * 고정 길이 문자열을 위한 `CHAR` (저장시 후행 공백 제거, 필요시 비교를 위해 공백으로 채움)
        + 매우 짧은 문자열을 저장하려고 함
        + 모든 값의 길이가 거의 동일한 경우
        + 바이너리 데이터를 저장하고 바이트 단위로 비교하는 작업을 하려고 할 때
    * 너무 관대한 설정은 성능에 영향을 줌 (메모리 고정 할당, 임시 테이블 등)
    * 대용량 데이터를 저장하기 위한 `BLOB`(바이너리), `TEXT`(문자열)
        + 다른 유형과 달리 값들을 고유한 ID를 가진 개체로 처리함
        + InnoDB는 값의 크기가 너무 크면 외부 스토리지 영역을 사용함
        + 인덱스 사용 불가
        + 과거에는 이미지를 바이너리로 저장하는 것이 보편적이었으나, 데이터 크기 때문에 스키마 변경 작업이 느려지면서, 외부에 저장하고 이미지의 위치를 기록하는 방식이 권장됨
    * 미리 정의된 고유한 문자열 값 집합인 `ENUM`
        + 문자열을 정수로 압축해서 저장하므로 숫자 지정은 알아보기 힘들어서 비추천
        + 위의 이유로 오버헤드가 있음 (`CHAR`/`VARCHAR를` `ENUM`에 조인하는 것은 `CHAR`/`VARCHAR`에 조인하는 것보다 느릴 수 있음)
        + 테이블 크기가 같은 값을 `VARCHAR`로 했을 때보다 1/3 정도 작아짐
        + `ENUM`을 추가하려면 항상 스키마 변경이 필요하므로 유의
- Date, Time
    * mySQL이 저장 가능한 가장 미세한 단위는 마이크로초
    * `TIMESTAMP`의 저장 공간이 더 작지만, 저장 가능한 시간대에 한계가 있으며, 시간대의 상대성을 보존함
        + 업데이트 규칙이 다소 복잡해서 버전별로 확인 필요
    * `DATETIME`은 알아보기 쉬운 형태로 저장됨
    * 고려할 점
        + 얼마나 많은 시간대를 저장해야 하는가
        + 저장 공간이 많이 중요한가
        + 마이크로초 지원이 필요한가
        + 시간대 처리를 mySQL에 위임할 것인가 / 애플리케이션 코드에서 처리할 것인가
- 비트
    * 참거짓을 나타내는 `BIT`
        + 웬만하면 피할 것
        + 충분히 큰 저장 공간을 할당 (공간 절약 불가)
        + 바이너리 값이라 직관적이지 않음
        + 대안: `CHAR(0)` / `TINYINT`
    * 여러 참거짓 요소를 묶어서 나타내는 `SET`
- `JSON`
    * 테이블 안에서 JSON 필드에 직접 접근할 수 있는 유형
    * JSON 타입으로 저장하기보다 테이블로 정의해서 저장하는 게 속도가 더 빠름
- 식별자 선택
    * 모든 관련 테이블에서 동일한 유형을 사용해야 함
    * 예상되는 데이터량에 적합한 공간을 할당해야 함
    * 추천 유형: `INT`
    * 비추천 유형: `ENUM`, `SET`, 문자열
- 자동 생성 스키마는 성능 문제를 일으킬 수 있으니 유의할 것
- IP의 구분자(.)는 읽는 사람을 위한 정보이니 문자열보다 정수로 저장하면 공간의 이점이 있음


## mySQL의 스키마 설계 문제
- 너무 많은 칼럼
    * mySQL이 행을 버퍼로 복사 > 디코딩 하는 식으로 동작함
    * 위 과정에서 변환 비용이 칼럼의 수에 영향을 받음
- 너무 많은 조인
    * EAV 디자인 패턴은 mySQL에서 잘 작동하지 않음
        + EAV? EAV(Entity-Attribute-Value) 디자인 패턴은 유연하고 동적인 스키마 디자인을 가능하게 하는 데이터베이스에서 사용되는 데이터 모델링 접근 방식. EAV 데이터 모델에서 각 엔터티 또는 객체는 키-값 쌍의 모음으로 표시됨. 기본 엔티티 테이블의 스키마를 변경하지 않고도 동적으로 추가하거나 수정할 수 있음. 데이터 모델이 자주 변경되는 경우에 유용함.
    * 빠른 쿼리를 위해서는 쿼리당 테이블을 12개 이하로 사용하는 것을 권함
- 지나친 `ENUM` 남용
- `ENUM`을 써야 하는데 헷갈려서 `SET`을 쓰는 경우 주의
- NULL을 쓰지 않는 게 좋긴 하지만, 대체재가 항상 좋은 것은 아님 (ex. `0000-00-00 00:00:00`)


## 스키마 관리
- 스키마 관리를 병목 지점으로 두지 말자
- 코드를 배포하듯 스키마를 관리하면 작업 속도 향상
    * 온라인으로 스키마 변경 작업 실행
    * CI/CD 파이프라인으로 통합
- 스키마 관리를 위한 툴이 있다: Flyway, Liquibase, Skeema 등