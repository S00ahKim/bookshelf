# 알림 시스템 설계

## 알림 시스템
- 고객에게 중요할 만한 정보를 비동기적으로 제공
- 모바일 푸시 알림, SMS 메시지, 이메일 등
    * iOS: 애플 푸시 알림 서비스(APNS)를 통해 알림을 보낼 수 있음. 단말 토큰 + payload가 필요.
    * 안드로이드: 유사함. APNS 대신 파이어베이스 클라우드 메시징(FCM) 사용
    * 메시지/이메일: 제3 사업자 서비스를 많이 사용함

## 구조
```
                    (데이터 분석 서비스)
[N개의 서비스] -> [알림 서버] -> [푸시 알림 큐] -> [작업 서버] -> [APNS 등] -> [수신자]
                  |                             |
                (캐 시)                 (알림 템플릿 / 로그)
```
- `서비스`: 알림 서버의 클라이언트. ex) 마이크로서비스 또는 크론잡
- `알림 서버`: 알림 전송, 알림 검증, 알림에 포함시킬 데이터 조회, 큐에 알림 넣기
    * 유의: 다수의 서버, 확장 가능한 DB와 캐시, 과부하되지 않도록 성능 관련 처리 필요
- `알림 큐`: 메시지 큐가 있으면 시스템 컴포넌트 간 강한 결합을 끊을 수 있다.
    * 큐 모니터링: 큐에 너무 많은 알림이 쌓이지 않도록 도와줌
- `작업 서버`: 메시지 큐에서 전송할 알림을 꺼내서 제3자 서비스로 전달
    * 안정성: 지연이 되더라도 손실되어선 안 된다 -> 재시도 매커니즘 필요
    * 중복 전송 방지: 이벤트 ID를 검사하기
    * 알림 템플릿: 유사한 포맷의 알림을 보낸다면 템플릿으로 관리하면 좋음
    * 전송률 제한: 한 사용자에게 너무 많은 알림을 보내지 않도록 제한
- `제3자 서비스`: 직접적으로 수신자에게 알림을 보내주는 서비스들
    * 보안: 인증되거나 승인된 클라이언트만 알림을 보낼 수 있다.
- `데이터 분석 서비스`: 사용자를 이해하는 데 중요한 메트릭 수집 및 제공

## 밑줄
- 연성 실시간 시스템: 알림이 가능한 빨리 전달되지만 시스템에 높은 부하가 걸릴 때 약간 지연될 수 있는 것
- opt-out: 사용자가 알림을 받지 않도록 설정
- 서버 하나의 장애가 전체 장애로 이어지지 않도록 SPOF를 제거하고, 컴포넌트를 쉽게 추가할 수 있도록 하는 것은 모든 설계에서 중요

## 질문
- 전송률 제한의 예시? 
    * 한 사람에게 보낼 수 있는 알림의 MAX 값을 정해 둔다거나 여러 방식으로 구현될 수 있을 듯하다.
    * 아무래도 일 단위보다는 초 단위로 제한하지 않을까 생각했고 로직 자체는 처리율제한(토큰 버킷 등)을 쓸 것 같다. 사용자 단위 제한을 할지 기기 단위 제한을 할지는 서비스 구상 시에 의사결정할 수 있는 부분일 듯 하다.
- 메시지 큐와 작업 서버는 어떻게 동작하는가?
    * RX 구조? 이벤트를 받아서 DB에 쏴줌. producer-consumer 구조.
    * RabbitMQ는 메시지 브로커 방식이고 Kafka는 pub/sub 방식
- 모바일 푸시 알림은 어떻게 동작하는가?
    * 푸시 알림(Push Notification)은 애플리케이션 서버에서 컴퓨팅 장치로 정보를 전달하는 것 (<> Pull Notification)
        - 서버에서 Event가 발생하면, 대상 Client의 토큰을 가지고 OSPNS(Operating System Push Notification Service)에 메시지 요청
        - OSPNS에서 설정한 프로토콜을 통해서 대상 Client의 주소를 찾아 메시지를 보냄 
    * iOS 푸시 알림 = APNS
    * 안드로이드 푸시 알림 = FCM(Firebase Cloud Messaging): 현재 FCM 은 Android/iOS/Mobile Web 을 모두 지원
    * AWS SNS (Simple Notification Service)
- 웹 푸시 알림은 어떻게?
    * Notification API - 브라우저가 닫혔을때 동작하지 않음
    * serviceworker API - 브라우저가 닫혔을때도 백그라운드에서 동작
    * 토큰 발급받아서 사용한다는 구조는 유사
    * [참고](https://developers.google.com/web/fundamentals/codelabs/push-notifications?hl=ko)