# 유튜브 설계

## 비디오 업로드
### 비디오 업로드
1. 원본 저장소 업로드
2. 트랜스코딩 서버가 원본 저장소에서 영상을 가져와 트랜스코딩
    - 왜?
      - 타 단말에서 잘 재생되려면 호환 가능한 비트레이트와 포맷이어야 하기 때문 (호환성을 위해)
        * 포맷? `컨테이너`(데이터 바구니) + `코덱`(압축, 압축 해제 알고리즘)
      - 원본 영상은 저장 공간을 많이 차지하기 때문
      - 끊김 없는 영상 재생을 보장하기 위해 (대역폭에 따라 다르게 제공, 네트워크 상황이 달라지는 것 대응 ex. 모바일)
    - DAG
      - 트랜스코딩 작업의 특징: 자원 많이 소모 + 시간 많이 걸림 + 사용자별로 다른 요구사항
      - 각기 다른 유형의 비디오 프로세싱 파이프라인을 지원(`유연성`)하고, `병렬성`을 높이려면 추상화를 적절히 해서 실행할 태스크를 클라이언트 프로그래머가 정할 수 있도록 해야 한다. DAG는 그 해결책 중 하나.
    - 트랜스코딩 아키텍처
      1. 전처리기: 비디오 스트림을 GOP(작은 프레임 그룹, 몇 초 정도)로 분할하고, 이를 캐싱함. 작업에 대한 DAG를 생성.
      2. DAG 스케줄러: DAG를 스테이지 단위로 구분해서 각각을 자원 관리자의 작업 큐에 넣음
         + ex. stage1{task1(비디오추출), task2(오디오추출), task3(메타데이터추출)}, stage2{task1(비디오인코딩), task2(섬네일추출), task3(오디오인코딩)} // 이 요소 각각은 순서가 지정되어 있음
      3. 자원 관리자
         1. 작업 관리자가 작업 큐에서 우선순위 높은 작업을 처리하고, 작업 서버에 배치함.
         2. 작업 스케줄러는 실행을 지시하고 (작업-서버) 데이터를 실행 큐에 넣음.
         3. 작업 스케줄러는 작업이 끝나면 실행 큐에서 해당 작업을 제거.
      4. 작업 실행 서버: DAG에 정의된 작업을 수행. 작업 종류에 따라 다른 서버를 쓰기도 함. 1에서 캐싱한 데이터를 참조한다.
      5. 인코딩 끝
3. 병렬 처리
    - 완료되면 트랜스코딩 비디오 저장소로 업로드 => 트랜스코딩된 비디오를 CDN에 올림
    - 완료 이벤트를 큐에 넣음
    - 이벤트 핸들러가 메타데이터 갱신
4. API 서버가 단말에 업로드 종료를 알림
5. 메타데이터 갱신 (-> API 서버)

## 비디오 스트리밍(재생)
- 영상을 로컬에 다운받아 실행시키는 것이 아니라, 지속적으로 비디오 스트림을 전송받는 것을 의미
- CDN에서 바로 스트리밍됨
- 스트리밍 프로토콜
    * 비디오 스트리밍을 위해 데이터 전송 시 쓰이는 표준화된 통신 방법
    * ex. MPEG-DASH, Apple HLS, ...
    * 프로토콜마다 지원한느 비디오 인코딩과 플레이어가 다르다

## 시스템 최적화
> 최적화 시도 전에 시청 패턴을 분석할 것
### 속도
1. 비디오 병렬 업로드 (원본을 한번에 전송하기보다 GOP단위로 전송하면 일부가 실패해도 복구가 쉬움)
2. 업로드 센터를 사용자 근거리에 지정
3. 모든 절차의 병렬화 (느슨하게 결합된 시스템, 의존성이 있으면 병렬성을 높이기 어렵기 때문)

### 비용
- 인기도에 따른 스트리밍 서버 분리
- 인기도에 따라 인코딩 과정 생략
- CDN을 직접 구축해서 인터넷 서비스 제공자(ISP)와 제휴

### 안정성
- 미리 사인된 업로드 URL
  * pre-signed url? 해당 url이 가리키는 객체에 대한 접근 권한이 주어진 상태
  * cf. 모든 객체는 기본적으로 비공개이며, 객체 소유자만 이러한 객체에 액세스할 수 있습니다. 그러나 객체 소유자는 필요할 경우 자신의 보안 자격 증명을 사용하여 일정 기간 동안 객체 다운로드를 허가하는 미리 서명된 URL을 만들어 다른 사용자와 객체를 공유할 수 있습니다. [참고: s3의 예시](https://dev.classmethod.jp/articles/create-pre-signed-url-in-s3/)
- 비디오 보호
  * DRM 기술: 인증된 사용자가 인증된 기간 동안만 사용가능 하도록 통제하는 등 사용을 제한하는 각종 기술
  * AES 암호화: 재생 시에만 복호화함
  * 워터마크: 이미지 오버레이 올리기

## 오류 처리
- 회복 가능한 오류의 경우 대부분 재시도로 해결된다.
- 회복 불가능한 오류의 경우 적절하게 오류 코드를 반환한다.

## 밑줄
- 유튜브에서는 (...) 많은 일을 할 수 있다. (...) 적절한 질문을 통해 설계 범위를 좁히자. "어떤 기능이 가장 중요한가요?" (p.248)
- 시스템 설계 면접은 모든 것을 밑바닥부터 만든느 것과는 관계가 없다. 주어진 시간 안에 적절한 기술을 골라 설계를 마치는 것이 그 기술 각각이 어떻게 동작하는지 상세히 설명하는 것보다 중요하다. (p. 251)
- 라이브 스트리밍의 경우 응답지연이 좀 더 낮아야 한다. 따라서 스트리밍 프로토콜 선정에 유의해야 한다. (...) 병렬화 필요성은 떨어질 텐데, 작은 단위의 데이터를 실시간으로 빨리 처리해야 하기 때문이다. (p. 273)

## 아하
- BLOB 스토리지(Binary Large Object Storage) = 이진 데이터를 하나의 개체로 보관하는 데이터베이스 관리 시스템.
- 트랜스코딩 = 인코딩
- CDN 엣지 서버 = 네트워크 진입점을 제공하는 장치. 인터넷 교환 지점(IxP)에 배치됨. 목적은 클라이언트와 최대한 가깝게 콘텐츠를 저장해서 레이턴시를 낮추는 것.
- 비트레이트 = 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지 나타내는 단위. 고화질일수록 높다.